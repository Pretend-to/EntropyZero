# EntropyZero 国际化实现指南

## 1. 技术架构

### 1.1 技术栈选择
- **react-i18next**: React 国际化库，功能强大且社区活跃
- **i18next**: 核心国际化框架
- **i18next-browser-languagedetector**: 自动检测浏览器语言
- **i18next-http-backend**: 动态加载语言包

### 1.2 项目结构
```
packages/app/
├── src/
│   ├── i18n/
│   │   ├── index.ts              # i18n 配置入口
│   │   ├── detector.ts           # 语言检测配置
│   │   └── resources/            # 语言资源文件
│   │       ├── zh-CN/
│   │       │   ├── common.json   # 通用文本
│   │       │   ├── ui.json       # 界面文本
│   │       │   ├── task.json     # 任务相关
│   │       │   └── error.json    # 错误信息
│   │       ├── en-US/
│   │       └── ja-JP/
│   ├── hooks/
│   │   └── useI18n.ts            # 国际化 Hook
│   └── utils/
│       └── formatters.ts         # 格式化工具
```

## 2. 依赖配置

### 2.1 安装依赖
```bash
pnpm add react-i18next i18next i18next-browser-languagedetector i18next-http-backend
pnpm add -D @types/react-i18next
```

### 2.2 package.json 更新
```json
{
  "dependencies": {
    "react-i18next": "^13.5.0",
    "i18next": "^23.7.0",
    "i18next-browser-languagedetector": "^7.2.0",
    "i18next-http-backend": "^2.4.0"
  }
}
```

## 3. 核心配置文件

### 3.1 i18n 主配置 (src/i18n/index.ts)
```typescript
import i18n from 'i18next'
import { initReactI18next } from 'react-i18next'
import LanguageDetector from 'i18next-browser-languagedetector'
import Backend from 'i18next-http-backend'

// 导入语言资源
import zhCN from './resources/zh-CN'
import enUS from './resources/en-US'
import jaJP from './resources/ja-JP'

const resources = {
  'zh-CN': zhCN,
  'en-US': enUS,
  'ja-JP': jaJP,
}

i18n
  .use(Backend)
  .use(LanguageDetector)
  .use(initReactI18next)
  .init({
    resources,
    fallbackLng: 'zh-CN',
    debug: process.env.NODE_ENV === 'development',
    
    // 语言检测配置
    detection: {
      order: ['localStorage', 'navigator', 'htmlTag'],
      caches: ['localStorage'],
      lookupLocalStorage: 'entropy-zero-language',
    },
    
    // 插值配置
    interpolation: {
      escapeValue: false, // React 已经处理了 XSS
      format: (value, format, lng) => {
        if (format === 'number') {
          return new Intl.NumberFormat(lng).format(value)
        }
        if (format === 'currency') {
          return new Intl.NumberFormat(lng, {
            style: 'currency',
            currency: 'CNY'
          }).format(value)
        }
        return value
      }
    },
    
    // 命名空间配置
    ns: ['common', 'ui', 'task', 'error'],
    defaultNS: 'common',
    
    // 后备配置
    saveMissing: true,
    missingKeyHandler: (lng, ns, key) => {
      console.warn(`Missing translation: ${lng}.${ns}.${key}`)
    }
  })

export default i18n
```

### 3.2 语言检测器配置 (src/i18n/detector.ts)
```typescript
import { DetectorOptions } from 'i18next-browser-languagedetector'

export const detectorOptions: DetectorOptions = {
  // 检测顺序：本地存储 > 浏览器语言 > HTML lang 属性
  order: ['localStorage', 'navigator', 'htmlTag', 'path', 'subdomain'],
  
  // 缓存位置
  caches: ['localStorage'],
  
  // 本地存储键名
  lookupLocalStorage: 'entropy-zero-language',
  
  // 从路径检测语言
  lookupFromPathIndex: 0,
  
  // 从子域名检测语言
  lookupFromSubdomainIndex: 0,
  
  // 排除的路径
  excludeCacheFor: ['cimode'],
  
  // 检查白名单
  checkWhitelist: true
}
```

## 4. 语言资源文件

### 4.1 中文资源 (src/i18n/resources/zh-CN/index.ts)
```typescript
import common from './common.json'
import ui from './ui.json'
import task from './task.json'
import error from './error.json'

export default {
  common,
  ui,
  task,
  error
}
```

### 4.2 通用文本 (src/i18n/resources/zh-CN/common.json)
```json
{
  "app": {
    "name": "EntropyZero",
    "tagline": "空间思维任务引擎",
    "description": "基于本地优先理念的新一代任务管理系统"
  },
  "actions": {
    "save": "保存",
    "cancel": "取消",
    "delete": "删除",
    "edit": "编辑",
    "create": "创建",
    "search": "搜索",
    "filter": "筛选",
    "sort": "排序",
    "export": "导出",
    "import": "导入",
    "settings": "设置",
    "help": "帮助",
    "close": "关闭",
    "confirm": "确认",
    "back": "返回",
    "next": "下一步",
    "previous": "上一步",
    "finish": "完成"
  },
  "time": {
    "now": "现在",
    "today": "今天",
    "yesterday": "昨天",
    "tomorrow": "明天",
    "thisWeek": "本周",
    "lastWeek": "上周",
    "nextWeek": "下周",
    "thisMonth": "本月",
    "lastMonth": "上月",
    "nextMonth": "下月",
    "ago": "{{time}}前",
    "in": "{{time}}后",
    "minutes": "分钟",
    "hours": "小时",
    "days": "天",
    "weeks": "周",
    "months": "月",
    "years": "年"
  }
}
```

### 4.3 界面文本 (src/i18n/resources/zh-CN/ui.json)
```json
{
  "navigation": {
    "home": "主页",
    "canvas": "画布",
    "projects": "项目",
    "tasks": "任务",
    "tags": "标签",
    "settings": "设置",
    "profile": "个人资料"
  },
  "sidebar": {
    "projects": "项目",
    "currentProject": "当前项目",
    "personalTasks": "个人任务",
    "archivedProjects": "归档项目",
    "views": "视图",
    "importantTasks": "重要任务",
    "urgentTasks": "紧急任务",
    "completedTasks": "已完成",
    "tags": "标签",
    "addProject": "添加项目",
    "addTag": "添加标签"
  },
  "canvas": {
    "zoomIn": "放大",
    "zoomOut": "缩小",
    "fitToScreen": "适应屏幕",
    "resetZoom": "重置缩放",
    "addTask": "添加任务",
    "connectTasks": "连接任务",
    "deleteSelected": "删除选中",
    "undo": "撤销",
    "redo": "重做",
    "selectAll": "全选",
    "deselectAll": "取消全选"
  },
  "commandPalette": {
    "placeholder": "输入指令或搜索任务...",
    "quickActions": "快速操作",
    "aiAssistant": "AI 助手",
    "recentTasks": "最近任务",
    "navigation": "导航",
    "createTask": "创建新任务",
    "searchTasks": "搜索任务",
    "connectTasks": "连接任务",
    "aiTaskBreakdown": "智能任务拆解",
    "aiProjectPlanning": "项目规划助手",
    "aiPriorityAdvice": "优先级建议",
    "goToCanvas": "回到主画布",
    "openSettings": "打开设置"
  }
}
```

### 4.4 任务相关 (src/i18n/resources/zh-CN/task.json)
```json
{
  "status": {
    "todo": "待办",
    "inProgress": "进行中",
    "waiting": "等待",
    "done": "已完成",
    "blocked": "阻塞"
  },
  "priority": {
    "low": "低优先级",
    "medium": "中优先级",
    "high": "高优先级",
    "urgent": "紧急"
  },
  "fields": {
    "title": "任务标题",
    "description": "任务描述",
    "status": "状态",
    "priority": "优先级",
    "dueDate": "截止日期",
    "tags": "标签",
    "assignee": "负责人",
    "progress": "进度",
    "subtasks": "子任务",
    "dependencies": "依赖关系",
    "notes": "备注"
  },
  "actions": {
    "createTask": "创建任务",
    "editTask": "编辑任务",
    "deleteTask": "删除任务",
    "duplicateTask": "复制任务",
    "markComplete": "标记完成",
    "markIncomplete": "标记未完成",
    "addSubtask": "添加子任务",
    "addDependency": "添加依赖",
    "setDueDate": "设置截止日期",
    "assignTo": "分配给",
    "addTag": "添加标签",
    "moveTask": "移动任务"
  },
  "placeholders": {
    "taskTitle": "输入任务标题...",
    "taskDescription": "描述这个任务的详细内容...",
    "searchTasks": "搜索任务...",
    "addNote": "添加备注..."
  },
  "messages": {
    "taskCreated": "任务创建成功",
    "taskUpdated": "任务更新成功",
    "taskDeleted": "任务删除成功",
    "taskCompleted": "任务标记为完成",
    "noTasks": "暂无任务",
    "noResults": "没有找到匹配的任务"
  }
}
```

### 4.5 错误信息 (src/i18n/resources/zh-CN/error.json)
```json
{
  "network": {
    "offline": "网络连接已断开",
    "timeout": "请求超时，请重试",
    "serverError": "服务器错误，请稍后重试",
    "notFound": "请求的资源不存在",
    "unauthorized": "未授权访问",
    "forbidden": "访问被拒绝"
  },
  "validation": {
    "required": "此字段为必填项",
    "minLength": "至少需要 {{min}} 个字符",
    "maxLength": "不能超过 {{max}} 个字符",
    "invalidEmail": "请输入有效的邮箱地址",
    "invalidDate": "请输入有效的日期",
    "invalidUrl": "请输入有效的网址"
  },
  "task": {
    "titleRequired": "任务标题不能为空",
    "titleTooLong": "任务标题不能超过 100 个字符",
    "descriptionTooLong": "任务描述不能超过 1000 个字符",
    "invalidDueDate": "截止日期不能早于今天",
    "circularDependency": "检测到循环依赖，无法添加此依赖关系",
    "maxSubtasks": "子任务数量不能超过 50 个"
  },
  "file": {
    "uploadFailed": "文件上传失败",
    "fileTooLarge": "文件大小不能超过 {{maxSize}}",
    "invalidFileType": "不支持的文件类型",
    "corruptedFile": "文件已损坏，无法读取"
  },
  "general": {
    "unknownError": "发生未知错误",
    "operationFailed": "操作失败，请重试",
    "permissionDenied": "权限不足",
    "sessionExpired": "会话已过期，请重新登录"
  }
}
```

## 5. React Hook 封装

### 5.1 自定义 Hook (src/hooks/useI18n.ts)
```typescript
import { useTranslation } from 'react-i18next'
import { useMemo } from 'react'

export interface UseI18nReturn {
  t: (key: string, options?: any) => string
  language: string
  changeLanguage: (lng: string) => Promise<void>
  languages: string[]
  isRTL: boolean
  formatDate: (date: Date, options?: Intl.DateTimeFormatOptions) => string
  formatNumber: (number: number, options?: Intl.NumberFormatOptions) => string
  formatRelativeTime: (date: Date) => string
}

export const useI18n = (): UseI18nReturn => {
  const { t, i18n } = useTranslation()
  
  const isRTL = useMemo(() => {
    const rtlLanguages = ['ar', 'he', 'fa', 'ur']
    return rtlLanguages.includes(i18n.language.split('-')[0])
  }, [i18n.language])
  
  const formatDate = (date: Date, options?: Intl.DateTimeFormatOptions) => {
    return new Intl.DateTimeFormat(i18n.language, {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      ...options
    }).format(date)
  }
  
  const formatNumber = (number: number, options?: Intl.NumberFormatOptions) => {
    return new Intl.NumberFormat(i18n.language, options).format(number)
  }
  
  const formatRelativeTime = (date: Date) => {
    const now = new Date()
    const diffInSeconds = Math.floor((now.getTime() - date.getTime()) / 1000)
    
    const rtf = new Intl.RelativeTimeFormat(i18n.language, { numeric: 'auto' })
    
    if (diffInSeconds < 60) {
      return rtf.format(-diffInSeconds, 'second')
    } else if (diffInSeconds < 3600) {
      return rtf.format(-Math.floor(diffInSeconds / 60), 'minute')
    } else if (diffInSeconds < 86400) {
      return rtf.format(-Math.floor(diffInSeconds / 3600), 'hour')
    } else if (diffInSeconds < 2592000) {
      return rtf.format(-Math.floor(diffInSeconds / 86400), 'day')
    } else if (diffInSeconds < 31536000) {
      return rtf.format(-Math.floor(diffInSeconds / 2592000), 'month')
    } else {
      return rtf.format(-Math.floor(diffInSeconds / 31536000), 'year')
    }
  }
  
  return {
    t,
    language: i18n.language,
    changeLanguage: i18n.changeLanguage,
    languages: Object.keys(i18n.options.resources || {}),
    isRTL,
    formatDate,
    formatNumber,
    formatRelativeTime
  }
}
```

## 6. 组件使用示例

### 6.1 基础使用
```typescript
import React from 'react'
import { useI18n } from '@/hooks/useI18n'

export const TaskCard: React.FC = () => {
  const { t, formatDate, formatRelativeTime } = useI18n()
  
  return (
    <div className="task-card">
      <h3>{t('task.fields.title')}</h3>
      <p>{t('task.status.todo')}</p>
      <span>{formatDate(new Date())}</span>
      <span>{formatRelativeTime(new Date(Date.now() - 3600000))}</span>
    </div>
  )
}
```

### 6.2 带参数的翻译
```typescript
import React from 'react'
import { useTranslation } from 'react-i18next'

export const TaskCounter: React.FC<{ count: number }> = ({ count }) => {
  const { t } = useTranslation()
  
  return (
    <span>
      {t('task.messages.taskCount', { count })}
    </span>
  )
}
```

### 6.3 语言切换组件
```typescript
import React from 'react'
import { useI18n } from '@/hooks/useI18n'

const languageNames = {
  'zh-CN': '简体中文',
  'en-US': 'English',
  'ja-JP': '日本語'
}

export const LanguageSwitcher: React.FC = () => {
  const { language, changeLanguage, languages } = useI18n()
  
  return (
    <select 
      value={language} 
      onChange={(e) => changeLanguage(e.target.value)}
    >
      {languages.map(lng => (
        <option key={lng} value={lng}>
          {languageNames[lng] || lng}
        </option>
      ))}
    </select>
  )
}
```

## 7. 构建和部署

### 7.1 Vite 配置更新
```typescript
// vite.config.ts
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import { resolve } from 'path'

export default defineConfig({
  plugins: [react()],
  resolve: {
    alias: {
      '@': resolve(__dirname, './src'),
    },
  },
  build: {
    rollupOptions: {
      output: {
        manualChunks: {
          'i18n': ['react-i18next', 'i18next']
        }
      }
    }
  }
})
```

### 7.2 应用入口配置
```typescript
// src/main.tsx
import React from 'react'
import ReactDOM from 'react-dom/client'
import App from './App'
import './i18n' // 导入 i18n 配置
import './index.css'

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
)
```

## 8. 测试策略

### 8.1 单元测试
```typescript
// src/hooks/__tests__/useI18n.test.ts
import { renderHook } from '@testing-library/react'
import { useI18n } from '../useI18n'

describe('useI18n', () => {
  it('should return translation function', () => {
    const { result } = renderHook(() => useI18n())
    expect(typeof result.current.t).toBe('function')
  })
  
  it('should format dates correctly', () => {
    const { result } = renderHook(() => useI18n())
    const date = new Date('2024-01-15')
    const formatted = result.current.formatDate(date)
    expect(formatted).toMatch(/2024/)
  })
})
```

### 8.2 集成测试
```typescript
// src/components/__tests__/TaskCard.test.tsx
import { render, screen } from '@testing-library/react'
import { I18nextProvider } from 'react-i18next'
import i18n from '../../i18n'
import { TaskCard } from '../TaskCard'

describe('TaskCard', () => {
  it('should render translated text', () => {
    render(
      <I18nextProvider i18n={i18n}>
        <TaskCard />
      </I18nextProvider>
    )
    
    expect(screen.getByText('任务标题')).toBeInTheDocument()
  })
})
```

## 9. 性能优化

### 9.1 懒加载语言包
```typescript
// src/i18n/index.ts
import i18n from 'i18next'
import { initReactI18next } from 'react-i18next'
import Backend from 'i18next-http-backend'

i18n
  .use(Backend)
  .use(initReactI18next)
  .init({
    lng: 'zh-CN',
    fallbackLng: 'zh-CN',
    
    backend: {
      loadPath: '/locales/{{lng}}/{{ns}}.json',
    },
    
    // 懒加载配置
    load: 'languageOnly',
    preload: ['zh-CN'], // 预加载默认语言
    
    // 缓存配置
    saveMissing: false,
    updateMissing: false,
  })
```

### 9.2 翻译缓存
```typescript
// src/utils/translationCache.ts
class TranslationCache {
  private cache = new Map<string, string>()
  
  get(key: string, lng: string): string | undefined {
    return this.cache.get(`${lng}:${key}`)
  }
  
  set(key: string, lng: string, value: string): void {
    this.cache.set(`${lng}:${key}`, value)
  }
  
  clear(): void {
    this.cache.clear()
  }
}

export const translationCache = new TranslationCache()
```

## 10. 最佳实践

### 10.1 翻译键命名规范
- 使用点分隔的层级结构：`namespace.category.item`
- 保持键名简洁且有意义
- 避免使用特殊字符和空格
- 使用驼峰命名法：`taskStatus.inProgress`

### 10.2 文本处理原则
- 避免硬编码文本，所有用户可见文本都应该国际化
- 使用插值而不是字符串拼接
- 考虑文本长度变化对布局的影响
- 提供上下文信息帮助翻译者理解

### 10.3 维护策略
- 定期审查和更新翻译
- 建立翻译审核流程
- 使用翻译管理工具
- 收集用户反馈改进翻译质量

这份指南提供了完整的国际化实现方案，确保 EntropyZero 能够为全球用户提供本地化的优质体验。